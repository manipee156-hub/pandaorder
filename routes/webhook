const express = require("express");
const router = express.Router();
const supabase = require("../db");
const crypto = require("crypto");

router.post(
  "/lemonsqueezy",
  express.raw({ type: "application/json" }),
  async (req, res) => {
    try {
      const secret = process.env.LEMON_WEBHOOK_SECRET;
      const signature = req.headers["x-signature"];

      const hmac = crypto.createHmac("sha256", secret);
      const digest = Buffer.from(
        hmac.update(req.body).digest("hex"),
        "utf8"
      );

      const checksum = Buffer.from(signature, "utf8");

      if (!checksum || !crypto.timingSafeEqual(digest, checksum)) {
        console.log("Invalid signature ‚ùå");
        return res.status(401).json({ error: "Invalid signature" });
      }

      const event = JSON.parse(req.body.toString());
      const eventName = event.meta?.event_name;
      const attributes = event.data?.attributes;

      if (!attributes) {
        return res.status(200).json({ received: true });
      }

      const email = attributes.user_email;

      if (eventName === "subscription_created") {
        await supabase
          .from("users")
          .update({
            plan: "monthly",
            plan_status: "active",
            plan_expires_at: attributes.renews_at,
          })
          .eq("email", email);

        console.log("Subscription created:", email);
      }

      if (eventName === "subscription_cancelled") {
        await supabase
          .from("users")
          .update({
            plan_status: "cancelled",
          })
          .eq("email", email);

        console.log("Subscription cancelled:", email);
      }

      res.status(200).json({ success: true });
    } catch (error) {
      console.error("Webhook error:", error);
      res.status(500).json({ message: "Webhook error" });
    }
  }
);

module.exports = router;