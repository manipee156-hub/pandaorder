// controllers/publicOrderController.js
const supabase = require("../db");
const { sendOrderEmail } = require("../services/emailService");

const createPublicOrder = async (req, res) => {
  try {
    const { public_id } = req.params;
    const { name, phone, address, product, bot } = req.body;

    // ğŸ•³ 1ï¸âƒ£ Honeypot
    if (bot) {
      return res.status(400).json({ error: "Spam detected" });
    }

    // âœ… 2ï¸âƒ£ Validation
    if (!name || name.length < 2) {
      return res.status(400).json({ error: "Ø§Ø³Ù… ØºÙŠØ± ØµØ§Ù„Ø­" });
    }

    if (!phone || phone.length < 8) {
      return res.status(400).json({ error: "Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ§Ù„Ø­" });
    }

    if (!address || address.length < 5) {
      return res.status(400).json({ error: "Ø¹Ù†ÙˆØ§Ù† ØºÙŠØ± ØµØ§Ù„Ø­" });
    }

    // ğŸ” 3ï¸âƒ£ Ø¬Ù„Ø¨ Ø§Ù„ØªØ§Ø¬Ø±
    const { data: user, error: userError } = await supabase
      .from("users")
      .select("id, email")
      .eq("public_id", public_id)
      .single();

    if (userError || !user) {
      return res.status(404).json({ error: "Invalid link" });
    }

    // ğŸ§¬ 4ï¸âƒ£ Fingerprint
    const fingerprint = req.ip + "-" + req.headers["user-agent"];

    // ğŸ” 5ï¸âƒ£ Duplicate Check
    const { data: existing } = await supabase
      .from("orders")
      .select("id")
      .eq("client_id", user.id)
      .eq("phone", phone)
      .single();

    if (existing) {
      return res.status(400).json({
        error: "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ù…Ø³Ø¨Ù‚Ù‹Ø§",
      });
    }

    // ğŸ“ 6ï¸âƒ£ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨
    const { data: order, error: orderError } = await supabase
      .from("orders")
      .insert([{
        client_id: user.id,
        customer_name: name,
        phone,
        address,
        product,
        fingerprint,
      }])
      .select();

    if (orderError) throw orderError;

    // ğŸ“§ 7ï¸âƒ£ Ø¥Ø±Ø³Ø§Ù„ Ø¥ÙŠÙ…ÙŠÙ„ Ù„Ù„ØªØ§Ø¬Ø±
    await sendOrderEmail(user.email, {
      name,
      phone,
      address,
      product,
    });

    res.json({
      message: "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ âœ…",
      order: order[0],
    });

  } catch (err) {
    console.error(err);
    res.status(500).json({ error: "Server error" });
  }
};

module.exports = { createPublicOrder };