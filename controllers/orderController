const supabase = require("../db");
const { sendOrderEmail } = require("../services/emailService");

// إنشاء طلب
const createOrder = async (req, res) => {
  try {
    const { customer_name, phone, address, product } = req.body;
    const userId = req.user.id; // ← من التوكن

    if (!customer_name || !phone || !address || !product) {
      return res.status(400).json({ error: "Missing fields" });
    }

    // جلب client_id و email
    const { data: userData, error: userError } = await supabase
      .from("users")
      .select("client_id, email")
      .eq("id", userId)
      .single();

    if (userError) throw userError;

    // إدخال الطلب
    const { data: orderData, error: insertError } = await supabase
      .from("orders")
      .insert([{
        client_id: userData.client_id,
        customer_name,
        phone,
        address,
        product
      }])
      .select();

    if (insertError) throw insertError;

    // إرسال الإيميل
    await sendOrderEmail(userData.email, {
      customer_name,
      phone,
      address,
      product
    });

    res.json({
      message: "Order created successfully",
      order: orderData[0]
    });

  } catch (err) {
    console.error(err);
    res.status(500).json({ error: "Server error" });
  }
};

// جلب الطلبات
const getOrders = async (req, res) => {
  try {
    const userId = req.user.id;

    const { data: userData } = await supabase
      .from("users")
      .select("client_id")
      .eq("id", userId)
      .single();

    const { data: orders, error } = await supabase
      .from("orders")
      .select("*")
      .eq("client_id", userData.client_id)
      .order("created_at", { ascending: false });

    if (error) throw error;

    res.json(orders);
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: "Server error" });
  }
};

module.exports = { createOrder, getOrders };